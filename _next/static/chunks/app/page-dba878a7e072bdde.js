(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{7393:function(t,e,a){Promise.resolve().then(a.bind(a,7340))},7340:function(t,e,a){"use strict";a.r(e),a.d(e,{default:function(){return r}});var s=a(7437),n=a(2265);class i{async open(){var t;this.device.opened||await this.device.open(),this.device.configuration&&this.device.configuration.configurationValue===this.settings.configuration.configurationValue||await this.device.selectConfiguration(this.settings.configuration.configurationValue);let e=this.settings.interface.interfaceNumber;this.device.configuration.interfaces[e].claimed||await this.device.claimInterface(e);let a=null!==(t=this.settings.alternate.alternateSetting)&&void 0!==t?t:0,s=this.device.configuration.interfaces[e];if(!s.alternate||s.alternate.alternateSetting!==a||s.alternates.length>1)try{await this.device.selectAlternateInterface(e,a)}catch(t){if(!s.alternate||s.alternate.alternateSetting!==a)throw t}}async close(){try{this.device.opened&&await this.device.close()}catch(t){}}async requestOut(t,e){var a;let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=await this.device.controlTransferOut({requestType:"class",recipient:"interface",request:t,value:s,index:this.settings.interface.interfaceNumber},e);if("ok"!==n.status)throw Error("controlTransferOut failed: ".concat(n.status));return null!==(a=n.bytesWritten)&&void 0!==a?a:0}async requestIn(t,e){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=await this.device.controlTransferIn({requestType:"class",recipient:"interface",request:t,value:a,index:this.settings.interface.interfaceNumber},e);if("ok"!==s.status)throw Error("controlTransferIn failed: ".concat(s.status));return s.data}async getStatus(){let t=await this.requestIn(i.DFU.GETSTATUS,6);return{status:t.getUint8(0),pollTimeout:16777215&t.getUint32(1,!0),state:t.getUint8(4)}}async getState(){return(await this.requestIn(i.DFU.GETSTATE,1)).getUint8(0)}async abortToIdle(){await this.requestOut(i.DFU.ABORT);let t=await this.getState();if(t===i.STATE.dfuERROR&&(await this.requestOut(i.DFU.CLRSTATUS),t=await this.getState()),t!==i.STATE.dfuIDLE)throw Error("Failed to return to IDLE, state=".concat(t))}async pollUntil(t){let e=await this.getStatus(),a=t=>new Promise(e=>setTimeout(e,t));for(;e.state!==t&&e.state!==i.STATE.dfuERROR;)console.debug("[DFU] sleep ".concat(e.pollTimeout,"ms (state=").concat(e.state,"/").concat(i.STATE_NAME[e.state],")")),await a(e.pollTimeout),e=await this.getStatus();return e}async dnloadBlock(t,e){return await this.requestOut(i.DFU.DNLOAD,t,e),this.pollUntil(i.STATE.dfuDNLOAD_IDLE)}async dfuseSetAddress(t){let e=new ArrayBuffer(5),a=new DataView(e);a.setUint8(0,33),a.setUint32(1,t,!0),await this.abortToIdle();let s=await this.dnloadBlock(e,0);if(0!==s.status)throw Error("DFUSe SETADDR failed: status=".concat(s.status,", state=").concat(s.state))}async dfuseErase(t){let e=new ArrayBuffer(5),a=new DataView(e);a.setUint8(0,65),a.setUint32(1,t,!0),await this.abortToIdle();let s=await this.dnloadBlock(e,0);if(0!==s.status)throw Error("DFUSe ERASE failed: status=".concat(s.status,", state=").concat(s.state))}async getTransferSize(){let t=512|this.settings.configuration.configurationValue,e=await this.device.controlTransferIn({requestType:"standard",recipient:"device",request:6,value:t,index:0},4);if("ok"!==e.status)throw Error(String(e.status));let a=e.data.getUint16(2,!0),s=await this.device.controlTransferIn({requestType:"standard",recipient:"device",request:6,value:t,index:0},a);if("ok"!==s.status)throw Error(String(s.status));let n=new DataView(s.data.buffer),i=9,r=!1;for(;i+2<=n.byteLength;){let t=n.getUint8(i),e=n.getUint8(i+1);if(t<2)break;if(4===e){let t=n.getUint8(i+2),e=n.getUint8(i+3),a=n.getUint8(i+5),s=n.getUint8(i+6),o=n.getUint8(i+7);r=t===this.settings.interface.interfaceNumber&&e===this.settings.alternate.alternateSetting&&254===a&&1===s&&2===o}else if(r&&33===e)return n.getUint16(i+5,!0)||2048;i+=t}return 2048}async do_download(t,e,a){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;await this.abortToIdle();let n=new Uint8Array(e),r=0,o=s;for(this.logProgress(0,n.byteLength);r<n.byteLength;){let e=Math.min(t,n.byteLength-r);console.log("[DFU] Sending block ".concat(o," size ").concat(e));let a=await this.dnloadBlock(n.slice(r,r+e).buffer,o++);if(0!==a.status)throw Error("DFU DOWNLOAD failed state=".concat(a.state," status=").concat(a.status));r+=e,this.logProgress(r,n.byteLength)}if(console.log("[DFU] Sending final ZLP (block ".concat(o,")")),await this.requestOut(i.DFU.DNLOAD,new ArrayBuffer(0),o++),a){let t=await this.pollUntil(i.STATE.dfuIDLE);if(0!==t.status)throw Error("DFU MANIFEST failed state=".concat(t.state," status=").concat(t.status))}else try{await this.getStatus()}catch(t){}}constructor(t,e){this.logProgress=()=>{},this.device=t,this.settings=e}}function r(){let{lines:t,log:e,clear:a}=function(){let[t,e]=(0,n.useState)([]);return{lines:t,log:(0,n.useCallback)(function(){for(var t=arguments.length,a=Array(t),s=0;s<t;s++)a[s]=arguments[s];let n=a.map(t=>"string"==typeof t?t:JSON.stringify(t)).join(" ");console.log(n),e(t=>[...t,n])},[]),clear:()=>e([])}}(),[r,o]=(0,n.useState)(!1),[l,c]=(0,n.useState)({done:0,total:0}),[d,u]=(0,n.useState)(null),[f,h]=(0,n.useState)(null),g=(0,n.useRef)(null),w=async t=>{let a=t.currentTarget.files;if(a)for(let t of Array.from(a)){let a=await t.arrayBuffer();t.name.toLowerCase().includes("bootstub")?h(a):u(a),e("[v0] Loaded ".concat(t.name," (").concat(a.byteLength," bytes)"))}},b=(0,n.useCallback)(async()=>{a();try{let t=await navigator.usb.requestDevice({filters:[{vendorId:1155,productId:57105},{classCode:254,subclassCode:1}]});e("[v0] Found device:",t);let a=function(t){let e=[];for(let a of t.configurations||[])for(let t of a.interfaces||[])for(let s of t.alternates||[])254===s.interfaceClass&&1===s.interfaceSubclass&&2===s.interfaceProtocol&&e.push({configuration:a,interface:t,alternate:s,name:s.interfaceName});return e}(t);if(0===a.length)throw Error("No DFU (protocol 2) interface found. Put device in DFU mode.");let s=a[0];e("[v0] Selected DFU interface/alt:",s.interface.interfaceNumber,s.alternate.alternateSetting);let n=new i(t,s);n.logProgress=(t,e)=>c({done:t,total:null!=e?e:t}),await n.open(),g.current=n,o(!0),e("[v0] Device opened successfully")}catch(t){e("[v0] Connect failed:",(null==t?void 0:t.message)||String(t)),o(!1)}},[a,e]),S=(0,n.useCallback)(async()=>{try{var t;await (null===(t=g.current)||void 0===t?void 0:t.close())}catch(t){}g.current=null,o(!1),e("[v0] Disconnected.")},[e]),D=(0,n.useCallback)(async(t,a,s)=>{let n;let i=new Set;for(let r of s)if(!i.has(r)){i.add(r);try{e("[v0] Using wTransferSize = ".concat(r)),await t.do_download(r,a,!0,2);return}catch(t){n=t,e("[v0] Transfer size ".concat(r," failed: ").concat(t instanceof Error?t.message:String(t)))}}throw n},[e]),E=(0,n.useCallback)(async()=>{let t=g.current;if(!t)return e("[v0] No device connected");if(!d||!f)return e("[v0] Please select panda.bin and bootstub.panda.bin");try{e("[v0] Firmware data prepared — Panda: ".concat(d.byteLength," bytes, Bootstub: ").concat(f.byteLength," bytes"));let s=[await t.getTransferSize(),2048,1024,512,256];e("[v0] DFUSe: ERASE panda pages"),await t.dfuseErase(134234112),await t.dfuseErase(134250496),await t.dfuseErase(134266880),e("[v0] DFUSe: SETADDR 0x08004000"),await t.dfuseSetAddress(134234112),e("[v0] Writing panda.bin (start block 2)"),await D(t,d,s),e("[v0] DFUSe: ERASE bootstub page"),await t.dfuseErase(134217728),e("[v0] DFUSe: SETADDR 0x08000000"),await t.dfuseSetAddress(134217728),e("[v0] Writing bootstub.panda.bin (start block 2)"),await D(t,f,s);try{var a;await (null===(a=t.requestOut)||void 0===a?void 0:a.call(t,0,0,1e3))}catch(t){}e("[v0] Flash complete \uD83C\uDF89")}catch(t){e("[v0] Flash failed:",(null==t?void 0:t.message)||String(t))}},[f,e,d,D]),v=(0,n.useMemo)(()=>l.total?Math.min(100,Math.floor(l.done/l.total*100)):0,[l]);return(0,s.jsxs)("div",{className:"max-w-2xl mx-auto p-6 space-y-4",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold",children:"White Panda – Web DFU (DFUSe) Flasher"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{className:"px-4 py-2 rounded bg-blue-600 text-white disabled:opacity-50",onClick:b,disabled:r,children:"Connect"}),(0,s.jsx)("button",{className:"px-4 py-2 rounded bg-gray-600 text-white disabled:opacity-50",onClick:S,disabled:!r,children:"Disconnect"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"block text-sm font-medium",children:"Upload binaries (panda.bin and bootstub.panda.bin)"}),(0,s.jsx)("input",{type:"file",multiple:!0,onChange:w})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("div",{className:"h-3 w-full bg-gray-200 rounded",children:(0,s.jsx)("div",{className:"h-3 bg-green-600 rounded",style:{width:"".concat(v,"%"),transition:"width .2s ease"}})}),(0,s.jsxs)("div",{className:"text-sm text-gray-600",children:["Progress: ",l.done,"/",l.total," bytes (",v,"%)"]})]}),(0,s.jsx)("button",{className:"px-4 py-2 rounded bg-emerald-600 text-white disabled:opacity-50",onClick:E,disabled:!r||!d||!f,children:"Flash Firmware"}),(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsx)("div",{className:"text-sm font-medium mb-1",children:"Log"}),(0,s.jsx)("div",{className:"h-56 overflow-auto rounded border p-2 text-xs bg-black text-green-300",children:t.map((t,e)=>(0,s.jsx)("div",{children:t},e))})]}),(0,s.jsxs)("p",{className:"text-xs text-gray-500",children:["You should see ",(0,s.jsx)("code",{children:"ERASE"})," and ",(0,s.jsx)("code",{children:"SETADDR"})," logs, then the first data block as ",(0,s.jsx)("code",{children:"block 2"}),". If a transfer size is too large, the app automatically retries with a smaller one."]})]})}i.DFU={DETACH:0,DNLOAD:1,UPLOAD:2,GETSTATUS:3,CLRSTATUS:4,GETSTATE:5,ABORT:6},i.STATE={appIDLE:0,appDETACH:1,dfuIDLE:2,dfuDNLOAD_SYNC:3,dfuDNBUSY:4,dfuDNLOAD_IDLE:5,dfuMANIFEST_SYNC:6,dfuMANIFEST:7,dfuMANIFEST_WAIT_RESET:8,dfuUPLOAD_IDLE:9,dfuERROR:10},i.STATE_NAME={0:"appIDLE",1:"appDETACH",2:"dfuIDLE",3:"dfuDNLOAD_SYNC",4:"dfuDNBUSY",5:"dfuDNLOAD_IDLE",6:"dfuMANIFEST_SYNC",7:"dfuMANIFEST",8:"dfuMANIFEST_WAIT_RESET",9:"dfuUPLOAD_IDLE",10:"dfuERROR"}}},function(t){t.O(0,[971,117,744],function(){return t(t.s=7393)}),_N_E=t.O()}]);